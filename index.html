<!DOCTYPE html>
<html lang="en">

<head>
  <title>Best Boats</title>
  <link rel="shortcut icon" href="blimp-icon.png">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- <link rel="stylesheet" href="tabs.css"> -->
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script> -->


  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
    crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>

  <script src="utils.js"></script>
  <script src="docsapi.js"></script>
  <link rel="stylesheet" href="css/style.css">
  <!-- <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY"
     crossorigin="anonymous"></script>
   <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ"
     crossorigin="anonymous"></script> -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
    crossorigin="anonymous">

</head>

<body>


  <div class="wrapper">
    <!-- Sidebar  -->
    <nav id="sidebar">
      <div class="sidebar-header">
        <h3>Guns of Icarus Info</h3>
      </div>
      <div class="sidebar-header collapsed">
        <h3><i class="fas fa-atom"></i></h3>
      </div>

      <ul class="list-unstyled components">

        <!-- <li id="shipBuildsLink" data-show="#shipBuilds">
          <a href="#" class="active">
            <i class="fas fa-ship"></i>
            Ship builds
          </a>
        </li> -->


        <li id="matchAnalysisLink" data-show="#matchAnalysis">
          <a href="#">
            <i class="fas fa-glasses"></i>
            Match history analysis
          </a>
        </li>
        <li id="matchesLink" data-show="#matchDatabase">
          <a href="#">
            <i class="fas fa-book"></i>
            Competative match database
          </a>
        </li>
        <li id="matchSubmissionLink" data-show="#matchSubmission">
          <a href="#">
            <i class="fas fa-pen-nib"></i>
            Submit match to history
          </a>
        </li>

        <li id="gunnerCalculatorLink" data-show="#gunnerCalculator">
          <a href="#" class="active">
            <i class="fas fa-bomb"></i>
            Gunnery calculator
          </a>
        </li>
        <li id="projectileArcsLink" data-show="#projectileArcs">
            <a href="#">
            <i class="fas fa-meteor"></i>
            Projectile arcs
            </a>
          </li>
        <li id="aboutLink" data-show="#about">
          <a href="#">
            <i class="far fa-question-circle"></i>
            About
          </a>
        </li>

      </ul>

    </nav>
    <!-- Page Content  -->
    <div id="content" class="container-fluid">

      <!-- Ship database -->
      <div id="shipBuilds" class="content-panel" style="display:none">

        <div class="row row-margin">
          <div class="col-sm-6">
            <div class="input-group">
              <div class="input-group-prepend">
                <div class="input-group-text">Filter</div>
              </div>
              <select class="form-control" id="shipFilterModeSelect">
                <option>Include</option>
                <option>Exclude</option>
              </select>
              <select class="form-control" id="shipFilterSelect">
                <option>All</option>
                <option selected>Ship</option>
                <option>Build name</option>
                <option>Guns</option>
                <option>Strong VS</option>
                <option>Weak VS</option>
              </select>
              <input type="text" class="form-control" id="shipFilterText" placeholder="filter substring">
              <!-- <div class="input-group-append">
                  <button id="shipFilterBtn" class="btn btn-primary">Filter</button>
                </div> -->
            </div>
          </div>

        </div>

        <div class="row">
          <!-- <div class="col"></div> -->
          <div class="col">
            <table id="shipsTable" class="table table-bordered">
            </table>
          </div>

        </div>

      </div>

      <!-- Ship counterer -->
      <div id="matchAnalysis" class="content-panel" style="display:none">TODO: Statistical analysis on match history
      </div>

      <!-- Match Database -->
      <div id="matchDatabase" class="content-panel" style="display:none">
        <div class="row row-margin">
          <div class="col-sm-6">
            <div class="input-group">
              <div class="input-group-prepend">
                <div class="input-group-text">Filter</div>
              </div>
              <select class="form-control" id="matchFilterModeSelect">
                <option>Include</option>
                <option>Exclude</option>
              </select>
              <select class="form-control" id="matchFilterSelect">
                <option>All</option>
                <option>Date after (DDMMYYYY)</option>
                <option>Date before (DDMMYYYY)</option>
                <option>Event</option>
                <option>Ship</option>
                <option>Pilot</option>
              </select>
              <input type="text" class="form-control" id="matchFilterText" placeholder="filter substring">
              <!-- <div class="input-group-append">
                  <button id="shipFilterBtn" class="btn btn-primary">Filter</button>
                </div> -->
            </div>
          </div>
        </div>

        <!-- <button id="matchAddFilterBtn" class="btn btn-primary">Add another filter</button> -->
        <div class="row">
          <!-- <div class="col"></div> -->
          <div class="col">
            <table id="matchTable" class="table table-bordered">
            </table>
          </div>
        </div>
      </div>

      <!-- Match Submissions -->
      <div id="matchSubmission" class="content-panel" style="display:none">
        <p>Here you can submit a match to the database.</p>
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSf8Fyrz4MRAJ8MoDke7it8zB_ihARWv12TBQMtIKstVY3cGXw/viewform?embedded=true"
          width="640" height="2317" frameborder="0" marginheight="0" marginwidth="0">Loadingâ€¦</iframe>
      </div>

      <!-- Gunnery calculator -->
      <div id="gunnerCalculator" class="content-panel" style="display:block">
        <h1>Gunnery numbers</h1>
        <div class="row row-margin">
          <div class="col-sm-4">
            <div class="input-group">
              <div class="input-group-prepend small">
                <div class="input-group-text">Gun</div>
              </div>
              <select class="form-control" id="gunSelect">
                <option>Artemis</option>
                <option>Light Flak</option>
                <option>Gatling</option>
                <option>Flamethrower</option>
                <option>Light Carronade</option>
                <option>Harpoon</option>
                <option>Flare</option>
                <option>Mercury</option>
                <option>Mortar</option>
                <option>Banshee</option>
                <option>Mine</option>
                <option>Hades</option>
                <option>Heavy Flak Mk. I</option>
                <option>Heavy Flak Mk. II</option>
                <option>Hwatcha</option>
                <option>Heavy Carronade</option>
                <option>Lumberjack</option>
                <option>Minotaur</option>
                <option>Nemesis</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row row-margin">
          <div class="col-sm-4">
            <div class="input-group">
              <div class="input-group-prepend small">
                <div class="input-group-text">Ammo</div>
              </div>
              <select class="form-control" id="ammoSelect">
                <option>Normal</option>
                <option>Lochnagar</option>
                <option>Heavy</option>
                <option>Incendiary</option>
                <option>Burst</option>
                <option>Greased</option>
                <option>Lesmok</option>
                <option>Heatsink</option>
                <option>Charged</option>
                <option>Extended</option>
              </select>
            </div>
          </div>
        </div>
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="buffedCheckbox">
          <label class="form-check-label" for="buffedCheckbox">Buffed</label>
        </div>
        
        <table id="gunTable" class="fixed table table-bordered">
          <tr>
            <th>Range (m)</th>
            <th>Arming distance (m)</th>
            <th>Seconds / clip (s)</th>
            <th>Clip size</th>
            <th>AOE (m)</th>
          </tr>
          <tbody id="gunContent"></tbody>
        </table>

        <table id="damageTotalTable" class="fixed fist-wide table table-bordered">
          <tr>
            <th class="medium">Damage (primary + secondary)</th>
            <th class="medium">
              Armor
              <br>
              <select id="armorUnitSelect" class="btn btn-mini">
                <option>HP</option>
                <option>Mallets</option>
                <option>Galleon A.</option>
                <option>Pyramidion A.</option>
                <option>Stormbreaker A.</option>
              </select>
            </th>
            <th class="medium">
              Hull
              <br>
              <select id="hullUnitSelect" class="btn btn-mini">
                <option>HP</option>
                <option>Galleon H.</option>
                <option>Pyramidion H.</option>
                <option>Stormbreaker H.</option>
              </select>
            </th>
            <th class="medium">
              Balloon
              <br>
              <select id="balloonUnitSelect" class="btn btn-mini">
                <option>HP</option>
                <option>B. Mallets</option>
                <option>Balloons</option>
              </select>
            </th>
            <th class="medium">
              Component
              <br>
              <select id="componentUnitSelect" class="btn btn-mini">
                <option>HP</option>
                <option>Mallets</option>
                <option>Light Guns</option>
                <option>Heavy Guns</option>
                <option>Light Engines</option>
                <option>Heavy Engines</option>
              </select>
            </th>
          </tr>
          <tbody id="damageTableContent"></tbody>
        </table>

      </div>

      <!-- Arc calculator -->
      <div id="projectileArcs" class="content-panel" style="display:none">
        <h1>Warning, construction zone ahead. Wear you hardhat.</h1>

        <canvas id="myCanvas" width="400" height="400" style="border:1px solid #d3d3d3;">
            Your browser does not support the HTML5 canvas tag.</canvas>

            <!-- <button type="button" id="arcDown">arc down</button> -->
            <!-- <button type="button" id="arcUp">arc up</button> -->
            <div id="mapContainer" class="img-canvas-container">
                <img id="mapImage" class='img' src="dunes-grid-small.png" width="400" height="400"/>
                <canvas id="mapCanvas" width="400" height="400"></canvas>
            </div>
        
          
          
          
      </div>
      <!-- About -->
      <div id="about" class="content-panel" style="display:none">
        <h3>About</h3>
        <p>
          Database can be found here: <br><a href="https://docs.google.com/spreadsheets/d/1Oo1-3ad5_8srmHnc_sUpxgF11kxsapyGs8ogd5cR46g/edit?usp=sharing">https://docs.google.com/spreadsheets/d/1Oo1-3ad5_8srmHnc_sUpxgF11kxsapyGs8ogd5cR46g/edit?usp=sharing</a>.
        </p>
        <p>
          Contact: <br> jjeessppeer+GoI@gmail.com
        </p>
        <p>Please send an email or a discord message if you feel like you know something cool that could be added to
          the site.</p>
        <p>
          If you for some reason wanna see the source i can send you a link.
        </p>
      </div>

    </div>


  </div>
  </div>


  <script>
    // https://www.brainbell.com/javascript/making-resizable-table-js.html

    var match_sheet;
    var match_dataset;

    var gun_dataset = null;
    var ammo_dataset = null;
    var damage_dataset = null;
    var ship_dataset = null;
    var tool_dataset = null;
    var component_dataset = null;

    $(document).ready(function () {

      $("li").on("click", sidebarLinkClicked);
      $("#shipFilterSelect,#shipFilterModeSelect").on("change", shipFilterSubmitted);
      $("#shipFilterText").on("input keydown keyup mousedown mouseup select contextmenu drop", shipFilterSubmitted);
      $("#matchFilterSelect,#matchFilterModeSelect").on("change", matchFilterSubmitted);
      $("#matchFilterText").on("input keydown keyup mousedown mouseup select contextmenu drop", matchFilterSubmitted);
      $("#gunSelect,#ammoSelect,#buffedCheckbox,#armorUnitSelect,#hullUnitSelect,#balloonUnitSelect,#componentUnitSelect").on("change", gunnerySelectionSubmitted);
      

      $('#mapImage').on('dragstart', function(event) { event.preventDefault(); });

      
      
      loadDatasetFromSheet("1Oo1-3ad5_8srmHnc_sUpxgF11kxsapyGs8ogd5cR46g", 2, function (dataset) {
        match_dataset = dataset;
        setMatchTableItems(match_dataset.getDatasetRows());
        matchFilterSubmitted();
      });
      loadDatasetFromSheet("1Oo1-3ad5_8srmHnc_sUpxgF11kxsapyGs8ogd5cR46g", 4, function (dataset) {
        gun_dataset = dataset;
        gunnerySelectionSubmitted();
      });
      loadDatasetFromSheet("1Oo1-3ad5_8srmHnc_sUpxgF11kxsapyGs8ogd5cR46g", 5, function (dataset) {
        ammo_dataset = dataset;
        gunnerySelectionSubmitted();
      });
      loadDatasetFromSheet("1Oo1-3ad5_8srmHnc_sUpxgF11kxsapyGs8ogd5cR46g", 6, function (dataset) {
        damage_dataset = dataset;
        gunnerySelectionSubmitted();
      });
      loadDatasetFromSheet("1Oo1-3ad5_8srmHnc_sUpxgF11kxsapyGs8ogd5cR46g", 7, function (dataset) {
        tool_dataset = dataset;
        gunnerySelectionSubmitted();
      });
      loadDatasetFromSheet("1Oo1-3ad5_8srmHnc_sUpxgF11kxsapyGs8ogd5cR46g", 8, function (dataset) {
        component_dataset = dataset;
        gunnerySelectionSubmitted();
      });
      loadDatasetFromSheet("1Oo1-3ad5_8srmHnc_sUpxgF11kxsapyGs8ogd5cR46g", 9, function (dataset) {
        ship_dataset = dataset;
        gunnerySelectionSubmitted();
      });


      var start_point = [1000, 1000, 100];
      var target_point = [2000, 2000, 100];
      let map_image = document.querySelector("#mapImage");
      var map_scale = 10.54 / (map_image.width / map_image.naturalWidth);
      var arc_scale = 10;

      $("#mapCanvas").on("mousemove mousedown", function(e){
        if (e.buttons != 1) return;
        let clickX = e.pageX - $(this).offset().left;
        let clickY = this.width - e.pageY + $(this).offset().top;
        let world_click_pos = [clickX * map_scale, clickY * map_scale];
        
        if (dist2D(target_point, world_click_pos) < dist2D(start_point, world_click_pos)){
          target_point[0] = world_click_pos[0];
          target_point[1] = world_click_pos[1];
        }
        else{
          start_point[0] = world_click_pos[0];
          start_point[1] = world_click_pos[1];
        }

        // target_point[0] = (e.pageX - $(this).offset().left) * map_scale
        // target_point[1] = (400 - e.pageY + $(this).offset().top) * map_scale

        // console.log(JSON.stringify(target_point))

        drawMapCanvas(start_point, target_point, map_scale);
        drawProjectileArc(target_point, start_point, arc_scale);
      });

      $("#myCanvas").on("mousemove", function(e){
        if (e.buttons != 1) return;
        let clickX = e.pageX - $(this).offset().left;
        let clickY = this.width - e.pageY + $(this).offset().top;
        
        let scaledClickPos = [clickX*arc_scale, clickY*arc_scale];

        let targetPos = [20 + dist2D(start_point, target_point), target_point[2]];
        let startPos = [20, start_point[2]];
        if (dist2D(scaledClickPos, targetPos) < dist2D(scaledClickPos, startPos)){
          target_point[2] = scaledClickPos[1];
        }
        else{
          start_point[2] = scaledClickPos[1];
        }

        // target_point[2] = worldY;

        drawProjectileArc(target_point, start_point, arc_scale);
      });


      drawProjectileArc(target_point, start_point, arc_scale);
      drawMapCanvas(start_point, target_point, map_scale);
    });


    function drawMapCanvas(start_point, target_point, map_scale){
      canvas = document.getElementById("mapCanvas");
      ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.arc(target_point[0] / map_scale, 400 - target_point[1] / map_scale, 10, 0, 2 * Math.PI, false);
      ctx.fillStyle = "red";
      ctx.fill();
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(start_point[0] / map_scale, 400 - start_point[1] / map_scale, 10, 0, 2 * Math.PI, false);
      ctx.fillStyle = "blue";
      ctx.fill();
      ctx.stroke();
    }

    function drawProjectileArc(target_point, start_point, draw_scale) {
      // Draw the side view of the projectile arc as shot from a point to another.

      let x_draw_offset = 20;

      let x_target = dist2D(target_point, start_point);
      let y_target = target_point[2];
      let y_start = start_point[2];
      
      let speed = 275;
      let drop = 20*0.7;
  
      let canvas = document.getElementById("myCanvas");
      let ctx = canvas.getContext("2d");

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      let data = searchAngle(speed, drop, y_start, [x_target, y_target]);
      for (let i=0; i<data.length-1; i++){
        ctx.beginPath();
        ctx.moveTo(x_draw_offset + data[i][0]/draw_scale, 400-data[i][1]/draw_scale);
        ctx.lineTo(x_draw_offset + data[i+1][0]/draw_scale, 400-data[i+1][1]/draw_scale);
        ctx.stroke();
      }

      ctx.beginPath();
      ctx.arc(x_draw_offset + x_target/draw_scale, canvas.height-y_target/draw_scale, 4, 0, 2 * Math.PI, false);
      ctx.fillStyle = "red";
      ctx.fill();
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(x_draw_offset, canvas.height-y_start/draw_scale, 4, 0, 2 * Math.PI, false);
      ctx.fillStyle = "blue";
      ctx.fill();
      ctx.stroke();
    }


    function shipFilterSubmitted() {
      let filterType = $("#shipFilterSelect").val();
      let filterMode = $("#shipFilterModeSelect").val() == "Exclude";
      let filterText = $("#shipFilterText").val();

      let dataset = null;
      if (filterType == "All" && !filterMode)
        dataset = ship_dataset;
      else if (filterType == "All" && filterMode)
        dataset = ship_dataset.getEmptyContent();
      else
        dataset = ship_dataset.filterByString(filterText, filterType, filterMode, false);
      setShipTableItems(dataset.getDatasetRows());
      // console.log(filterText, filterType);
      // console.log(ship_dataset.filterByString("", filterType, false, false).getDatasetRows());

    }

    function matchFilterSubmitted() {
      console.log("Filtering matches");
      let filterType = $("#matchFilterSelect").val();
      let filterMode = $("#matchFilterModeSelect").val() == "Exclude";
      let filterText = $("#matchFilterText").val();
      let dataset = null;
      if (filterType == "All" && !filterMode)
        dataset = match_dataset;
      else if (filterType == "All" && filterMode)
        dataset = match_dataset.getEmptyContent();
      else if (filterType == "Date after (DDMMYYYY)")
        dataset = match_dataset.filterByDate(filterText, "Date of match", filterMode, true);
      else if (filterType == "Date before (DDMMYYYY)")
        dataset = match_dataset.filterByDate(filterText, "Date of match", filterMode, false);
      else if (filterType == "Ship")
        dataset = match_dataset.filterByStringMultiCol(filterText, ["T1 Ship 1", "T1 Ship 2", "T2 Ship 1", "T2 Ship 2"], filterMode, false);
      else if (filterType == "Pilot")
        dataset = match_dataset.filterByStringMultiCol(filterText, ["T1S1 Pilot", "T1S2 Pilot", "T2S1 Pilot", "T2S2 Pilot"], filterMode, false);
      else
        dataset = match_dataset.filterByString(filterText, filterType, filterMode, false);

      setMatchTableItems(dataset.getDatasetRows());
    }

    function gunnerySelectionSubmitted() {
      if (!(gun_dataset && ammo_dataset && damage_dataset && tool_dataset && component_dataset && ship_dataset)) {
        console.log("Still loading");
        return;
      }
      console.log("Changing gun selection");
      let gunAlias = $("#gunSelect").val();
      let ammoAlias = $("#ammoSelect").val();
      setGunneryItems(
        gun_dataset.filterByString(gunAlias, "Alias").getDatasetRow(0),
        ammo_dataset.filterByString(ammoAlias, "Alias").getDatasetRow(0));
    }

    function setMatchTableItems(rows) {
      $("#matchTable").empty();
      let table_title = $(`
                <tr>
                  <th>Date</th>
                  <th>Event</th>
                  <th>Result</th>
                  <th>T1 Ships</th>
                  <th>T2 Ships</th>
                  <th>T1 Pilots</th>
                  <th>T2 Pilots</th>
                </tr>`);
      $("#matchTable").append(table_title);

      for (let i = 0; i < rows.length; i++) {
        let row = rows[i]
        let match_table_row = $(`
                <tr>
                  <td>` + row[1] + `</td>
                  <td>` + row[2] + `</td>
                  <td>` + row[3] + ":" + row[4] + `</td>
                  <td>` + row[5] + "<br>" + row[6] + `</td>
                  <td>` + row[7] + "<br>" + row[8] + `</td>
                  <td>` + row[9] + "<br>" + row[10] + `</td>
                  <td>` + row[11] + "<br>" + row[12] + `</td>
                </tr>`);
        $("#matchTable").append(match_table_row);
      }
    }

    function setShipTableItems(rows) {
      // let rows = sheet.getDbRowsByString("Stormbreaker", "Ship");
      $("#shipsTable").empty();
      let table_title = $(`
            <tr>
              <th>Ship</th>
              <th>Name</th>
              <th>Gun loadout</th>
              <th>Crew loadouts</th>
              <th>Crew positions</th>
              <th>Strategy</th>
              <th>Strong VS</th>
              <th>Weak VS</th>
            </tr>`);
      $("#shipsTable").append(table_title);

      for (let i = 0; i < rows.length; i++) {
        let row = rows[i]
        let ship_table_div = $(`
            <tr>
              <td rowspan="4">` + row[0] + `</td>
              <td rowspan="4">` + row[1] + `</td>
              <td rowspan="4">` + row[2].replace(/,/gi, "<br>") + `</td>
              <td>` + row[3] + `</td>
              <td>` + row[7] + `</td>
              <td rowspan="4">` + row[11] + `</td>
              <td rowspan="4">` + row[12].replace(/,/gi, "<br>") + `</td>
              <td rowspan="4">` + row[13].replace(/,/gi, "<br>") + `</td>
            </tr>
            <tr>
              <td>` + row[4] + `</td>
              <td>` + row[8] + `</td>
            </tr>
            <tr>
              <td>` + row[5] + `</td>
              <td>` + row[9] + `</td>
            </tr>
            <tr>
              <td>` + row[6] + `</td>
              <td>` + row[10] + `</td>
            </tr>`);

        // $("#shipsTable").append(ship_table_div);
        $("#shipsTable").append(ship_table_div);
      }

    }

    function setGunneryItems(gunRow, ammoRow) {
      if (!(gun_dataset && ammo_dataset && damage_dataset && tool_dataset && component_dataset && ship_dataset)) {
        console.log("Still loading");
        return;
      }

      let buffed = $("#buffedCheckbox").is(':checked');

      // Calculate stuff
      let clip_size = Math.max(1, Math.round(gunRow[8] * ammoRow[4]));
      let rate_of_fire = gunRow[6] * ammoRow[9];

      let range = gunRow[10] * ammoRow[10];
      let arming_distance = gunRow[15] * gunRow[9] * ammoRow[5] * ammoRow[10];
      let seconds_clip = Math.max((clip_size - 1) / rate_of_fire, 1); // Seconds per clip never below 1 
      let aoe = gunRow[13] * ammoRow[5];


      let damage_type_primary = gunRow[2];
      let damage_type_secondary = gunRow[4];

      let damage_hit_primary = gunRow[3] * ammoRow[7] * (buffed ? 1.2 : 1);
      let damage_hit_secondary = gunRow[5] * ammoRow[7] * ammoRow[6] * (buffed ? 1.2 : 1);
      // let damage_hit_secondary = gunRow[5] * ammoRow[7] * (aoe > 0 ? ammoRow[6] : 1) * (buffed ? 1.2 : 1);

      let damage_clip_primary = damage_hit_primary * clip_size;
      let damage_clip_secondary = damage_hit_secondary * clip_size;

      let damage_second_1_primary = damage_clip_primary / seconds_clip;
      let damage_second_1_secondary = damage_clip_secondary / seconds_clip;

      let damage_second_2_primary = damage_clip_primary / (parseFloat(seconds_clip) + parseFloat(gunRow[7]));
      let damage_second_2_secondary = damage_clip_secondary / (parseFloat(seconds_clip) + parseFloat(gunRow[7]));
      

      // Damage unit scales
      let unit_dict = {
        "HP": 1, 
        "Mallets": tool_dataset.getCellByString("Mallet", "Name", "Repair"),
        "Galleon A.": ship_dataset.getCellByString("Galleon", "Ship Type", "Armor"), 
        "Pyramidion A.": ship_dataset.getCellByString("Pyramidion", "Ship Type", "Armor"),
        "Stormbreaker A.": ship_dataset.getCellByString("Stormbreaker", "Ship Type", "Armor"),
        "Galleon H.": ship_dataset.getCellByString("Galleon", "Ship Type", "Hull Health"),
        "Pyramidion H.": ship_dataset.getCellByString("Pyramidion", "Ship Type", "Hull Health"),
        "Stormbreaker H.": ship_dataset.getCellByString("Stormbreaker", "Ship Type", "Hull Health"),
        "B. Mallets": (tool_dataset.getCellByString("Mallet", "Name", "Repair") / 0.76),
        "Balloons": component_dataset.getCellByString("Balloon", "Name", "HP"),
        "Light Guns": component_dataset.getCellByString("Light Gun", "Name", "HP"),
        "Heavy Guns": component_dataset.getCellByString("Heavy Gun", "Name", "HP"),
        "Light Engines": component_dataset.getCellByString("Light Engine", "Name", "HP"),
        "Heavy Engines": component_dataset.getCellByString("Heavy Engine", "Name", "HP")
      };

      let armor_unit_scale = 1 / unit_dict[$("#armorUnitSelect").val()];
      let hull_unit_scale = 1 / unit_dict[$("#hullUnitSelect").val()];
      let balloon_unit_scale = 1 / unit_dict[$("#balloonUnitSelect").val()];
      let component_unit_scale = 1 / unit_dict[$("#componentUnitSelect").val()];
      
      // Damage / shot
      let damage_shot_armor =     armor_unit_scale * (damage_hit_primary * getDamageMod(damage_type_primary, "Armor") + damage_hit_secondary * getDamageMod(damage_type_secondary, "Armor"));
      let damage_shot_hull =      hull_unit_scale * (damage_hit_primary * getDamageMod(damage_type_primary, "Hull") + damage_hit_secondary * getDamageMod(damage_type_secondary, "Hull"));
      let damage_shot_balloon =   balloon_unit_scale * (damage_hit_primary * getDamageMod(damage_type_primary, "Balloon") + damage_hit_secondary * getDamageMod(damage_type_secondary, "Balloon"));
      let damage_shot_component = component_unit_scale * (damage_hit_primary * getDamageMod(damage_type_primary, "Components") + damage_hit_secondary * getDamageMod(damage_type_secondary, "Components"));
      
      // Damage / clip
      let damage_clip_armor =     armor_unit_scale * (damage_clip_primary * getDamageMod(damage_type_primary, "Armor") + damage_clip_secondary * getDamageMod(damage_type_secondary, "Armor"));
      let damage_clip_hull =      hull_unit_scale * (damage_clip_primary * getDamageMod(damage_type_primary, "Hull") + damage_clip_secondary * getDamageMod(damage_type_secondary, "Hull"));
      let damage_clip_balloon =   balloon_unit_scale * (damage_clip_primary * getDamageMod(damage_type_primary, "Balloon") + damage_clip_secondary * getDamageMod(damage_type_secondary, "Balloon"));
      let damage_clip_component = component_unit_scale * (damage_clip_primary * getDamageMod(damage_type_primary, "Components") + damage_clip_secondary * getDamageMod(damage_type_secondary, "Components"));

      // Damage / second (one clip)
      let damage_second_1_armor =     armor_unit_scale * (damage_second_1_primary * getDamageMod(damage_type_primary, "Armor") + damage_second_1_secondary * getDamageMod(damage_type_secondary, "Armor"));
      let damage_second_1_hull =      hull_unit_scale * (damage_second_1_primary * getDamageMod(damage_type_primary, "Hull") + damage_second_1_secondary * getDamageMod(damage_type_secondary, "Hull"));
      let damage_second_1_balloon =   balloon_unit_scale * (damage_second_1_primary * getDamageMod(damage_type_primary, "Balloon") + damage_second_1_secondary * getDamageMod(damage_type_secondary, "Balloon"));
      let damage_second_1_component = component_unit_scale * (damage_second_1_primary * getDamageMod(damage_type_primary, "Components") + damage_second_1_secondary * getDamageMod(damage_type_secondary, "Components"));
      
      // Damage / second (with reloading)
      let damage_second_2_armor =     armor_unit_scale * (damage_second_2_primary * getDamageMod(damage_type_primary, "Armor") + damage_second_2_secondary * getDamageMod(damage_type_secondary, "Armor"));
      let damage_second_2_hull =      hull_unit_scale * (damage_second_2_primary * getDamageMod(damage_type_primary, "Hull") + damage_second_2_secondary * getDamageMod(damage_type_secondary, "Hull"));
      let damage_second_2_balloon =   balloon_unit_scale * (damage_second_2_primary * getDamageMod(damage_type_primary, "Balloon") + damage_second_2_secondary * getDamageMod(damage_type_secondary, "Balloon"));
      let damage_second_2_component = component_unit_scale * (damage_second_2_primary * getDamageMod(damage_type_primary, "Components") + damage_second_2_secondary * getDamageMod(damage_type_secondary, "Components"));
      
      // Fire / clip
      let fire_clip_base = parseFloat(gunRow[12] * ammoRow[11] * clip_size)
      let fire_clip_armor_primary = ammoRow[12] * damage_clip_primary * getDamageMod(damage_type_primary, "Armor");
      let fire_clip_armor_secondary = fire_clip_base + ammoRow[12] * damage_clip_secondary * getDamageMod(damage_type_secondary, "Armor");
      let fire_clip_balloon_primary = ammoRow[12] * damage_clip_primary * getDamageMod(damage_type_primary, "Balloon");
      let fire_clip_balloon_secondary = fire_clip_base + ammoRow[12] * damage_clip_secondary * getDamageMod(damage_type_secondary, "Balloon");
      let fire_clip_component_primary = ammoRow[12] * damage_clip_primary * getDamageMod(damage_type_primary, "Components");
      let fire_clip_component_secondary = fire_clip_base + ammoRow[12] * damage_clip_secondary * getDamageMod(damage_type_secondary, "Components");

      // Fill out UI

      let gunTableContents = $(`
          <tr>
            <td>` + range.toFixed(0) + `</td>
            <td>` + arming_distance.toFixed(0) + `</td>
            <td>` + seconds_clip.toFixed(1) + `</td>
            <td>` + clip_size + `</td>
            <td>` + aoe.toFixed(2) + `</td>
          </tr>`);
      $("#gunContent").empty();
      $("#gunContent").append(gunTableContents);

      let damageTableContents = $(`
          <tr>
            <th>Damage / shot</th>
            <td>` + precise(damage_shot_armor, 3) + `</td>
            <td>` + precise(damage_shot_hull, 3) + `</td>
            <td>` + precise(damage_shot_balloon, 3) + `</td>
            <td>` + precise(damage_shot_component, 3) + `</td>
          </tr>
          <tr>
            <th>Damage / second (one clip)</th>
            <td>` + precise(damage_second_1_armor, 3) + `</td>
            <td>` + precise(damage_second_1_hull, 3) + `</td>
            <td>` + precise(damage_second_1_balloon, 3) + `</td>
            <td>` + precise(damage_second_1_component, 3) + `</td>
          </tr>
          <tr>
            <th>Damage / second (with reloading)</th>
            <td>` + precise(damage_second_2_armor, 3) + `</td>
            <td>` + precise(damage_second_2_hull, 3) + `</td>
            <td>` + precise(damage_second_2_balloon, 3) + `</td>
            <td>` + precise(damage_second_2_component, 3) + `</td>
          </tr>
          <tr>
            <th>Damage / clip</th>
            <td>` + precise(damage_clip_armor, 3) + `</td>
            <td>` + precise(damage_clip_hull, 3) + `</td>
            <td>` + precise(damage_clip_balloon, 3) + `</td>
            <td>` + precise(damage_clip_component, 3) + `</td>
          </tr>
          <tr>
            <th>Fire / clip (avg.)</th>
            <td>` + precise(fire_clip_armor_primary + fire_clip_armor_secondary, 3) + `</td>
            <td>` + "-" + `</td>
            <td>` + precise(fire_clip_balloon_primary + fire_clip_balloon_secondary, 3) + `</td>
            <td>` + precise(fire_clip_component_primary + fire_clip_component_secondary, 3) + `</td>
          </tr>
      `);
      $("#damageTableContent").empty();
      $("#damageTableContent").append(damageTableContents);

    }

    function sidebarLinkClicked() {
      if ($(this).hasClass("subLink")) {
        $("#sidebar a").not($(this).parent().parent().find("> li > a")).removeClass("active");
        $(this).parent().parent().find("> li > a").addClass("active")
      }
      else {
        $("#sidebar a").removeClass("active");
      }
      $(this).find("> a").addClass("active");

      var div = $($(this).data("show")).show();
      div.siblings("div").hide();
    }


  </script>


</body>

</html>